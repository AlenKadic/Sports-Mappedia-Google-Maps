<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sports Mappedia — Data Browser</title>
  <meta name="description" content="This is unofficial fan created GIS hub for Sports events.">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="icon" href="data:,">
  <style>
    html, body { height: 100%; }
    .chip { display:inline-block; padding: 0.125rem 0.5rem; font-size: 0.75rem; border-radius: 9999px; border: 1px solid rgb(209 213 219); }
    .embedTall { height: 70vh; } /* map below the filters */
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-4">
    <header class="mb-4 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">Sports Mappedia</h1>
        <p class="text-sm text-gray-600">This is unofficial fan created GIS hub for Sports events.</p>
      </div>
      <!-- Keep status in DOM for scripts/assistive tech, but hide visually -->
      <span id="status" class="sr-only">Loading…</span>
    </header>

    <!-- Controls (top) -->
    <section class="bg-white rounded-2xl shadow p-4 mb-3">
      <div class="flex flex-col gap-3">
        <!-- Search + Category row -->
        <div class="flex flex-col md:flex-row md:items-start gap-3">
          <label class="flex-1">
            <span class="text-sm font-medium">Search (name, address, notes)</span>
            <div class="mt-1 flex gap-2">
              <input id="q" class="w-full border rounded-xl px-3 py-2" placeholder="Type to search…"/>
              <button id="btnSearch" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50">Search</button>
            </div>
            <div class="text-xs text-gray-500 mt-1">Press Search or Enter to show results.</div>
          </label>

          <label class="w-full md:w-64">
            <span class="text-sm font-medium">Category</span>
            <select id="category" class="mt-1 w-full border rounded-xl px-3 py-2">
              <option value="">All</option>
            </select>
          </label>

          <div class="flex items-start md:pt-6">
            <button id="btnReset" class="text-xs px-3 py-2 rounded-lg border hover:bg-gray-50 h-10">Reset</button>
          </div>
        </div>

        <!-- Results list (hidden until Search/Enter) -->
        <div id="resultsBlock" class="hidden">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Results</span>
            <span id="counts" class="text-xs text-gray-500">0</span>
          </div>
          <div id="results" class="mt-2 max-h-56 overflow-auto space-y-2 pr-1"></div>
        </div>
      </div>
    </section>

    <!-- Map (bottom) -->
    <section class="bg-white rounded-2xl shadow overflow-hidden">
      <iframe id="mymapsBrowser" class="w-full embedTall"
              src="https://www.google.com/maps/d/embed?mid=1flufWwvpBFS6g7t7rddkzZnWsyeMVCw&ehbc=2E312F"
              loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      <div class="p-3 text-xs text-gray-600 border-t">
        Note: My Maps iframes are read-only from this page; each result has an “Open in Google Maps” link.
      </div>
    </section>
  </div>

<script>
/* ===== Config (defaults + URL overrides) ===== */
const DEFAULTS = {
  mymap: "https://www.google.com/maps/d/embed?mid=1flufWwvpBFS6g7t7rddkzZnWsyeMVCw&ehbc=2E312F",
  csv:   "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPslbQfk_lxbc0FXX6IrdJEh1cfnuSpJRITDM9X4vxxXbVcimphgQJ1G4dVSJFCuloUAcrLkod-U9-/pub?gid=2019963302&single=true&output=csv"
};
const P = new URLSearchParams(location.search);
const SRC_MYMAP = P.get("mymap") || DEFAULTS.mymap;
const SRC_CSV   = P.get("csv")   || DEFAULTS.csv;

/* ===== State ===== */
let rawRows = [];
let filtered = [];
let resultsVisible = false;
const K = { name:'Name', category:'Category', layer:'Layer', lat:'Latitude', lon:'Longitude', address:'Address', notes:'Notes', url:'URL' };
const ALIASES = {
  Name: ['name','title','label','place','poi','naziv','ime'],
  Category: ['category','type','group','kategorija','vrsta'],
  Layer: ['layer','folder','sheet','tab','list','group'],
  Latitude: ['latitude','lat','y','y_coord','ycoord','φ','northing'],
  Longitude: ['longitude','lon','lng','long','x','x_coord','xcoord','λ','easting'],
  Address: ['address','location','addr','adresa','mjesto','city','town'],
  Notes: ['notes','description','desc','napomena','opis','info'],
  URL: ['url','link','website','href','web','maps','gmaps']
};

/* ===== DOM ===== */
const elStatus = document.getElementById('status');
const elQ = document.getElementById('q');
const elCat = document.getElementById('category');
const elResults = document.getElementById('results');
const elResultsBlock = document.getElementById('resultsBlock');
const elReset = document.getElementById('btnReset');
const elBtnSearch = document.getElementById('btnSearch');
const elCounts = document.getElementById('counts');

/* ===== Helpers ===== */
function setStatus(text, ok=true){
  // Keep updating (useful in dev / screen readers), but it remains visually hidden.
  elStatus.textContent = text;
  elStatus.style.borderColor = ok ? '#d1d5db' : '#ef4444';
  elStatus.style.color = ok ? '#111827' : '#991b1b';
}
function escapeHtml(s){ return (s ?? '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
function showResults(show){ elResultsBlock.classList.toggle('hidden', !show); resultsVisible = !!show; }

/* ===== CSV / gviz loader ===== */
async function tryPapaCsv(url){
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      header:true, download:true, dynamicTyping:true,
      complete: (res) => {
        const rows = res.data.filter(row => Object.keys(row).some(k => String(row[k]||'').trim() !== ''));
        resolve(rows);
      },
      error: reject
    });
  });
}
function buildGvizUrl(sheetCsvUrl){
  const mKey = sheetCsvUrl.match(/\/spreadsheets\/d\/e\/([^\/]+)/);
  const mGid = sheetCsvUrl.match(/[?&]gid=([0-9]+)/);
  if (!mKey || !mGid) return null;
  return `https://docs.google.com/spreadsheets/d/e/${mKey[1]}/gviz/tq?gid=${mGid[1]}&tqx=out:json`;
}
function loadGvizJson(sheetCsvUrl){
  return new Promise((resolve, reject) => {
    const url = buildGvizUrl(sheetCsvUrl);
    if (!url) return reject(new Error('Could not build gviz URL from Sheet CSV URL.'));
    window.google = window.google || {}; window.google.visualization = window.google.visualization || {};
    window.google.visualization.Query = {
      setResponse: function(resp){
        try{
          const table = resp.table;
          const cols = table.cols.map(c => c.label || c.id);
          const rows = table.rows.map(r => {
            const o={}; r.c.forEach((cell,idx)=>{ o[cols[idx]||`col${idx}`]=cell?cell.v:null; });
            return o;
          });
          resolve(rows);
        }catch(e){ reject(e); }
        finally{
          delete window.google.visualization.Query;
          const s=document.getElementById('gvizScriptLoader'); if(s) s.remove();
        }
      }
    };
    const s=document.createElement('script'); s.id='gvizScriptLoader'; s.async=true; s.src=url;
    s.onerror=()=>{ delete window.google.visualization.Query; reject(new Error('Failed to load gviz JSON.')); };
    document.body.appendChild(s);
  });
}
async function loadSheetRows(sheetCsvUrl){
  try { return await tryPapaCsv(sheetCsvUrl); }
  catch(e){ console.warn('CSV blocked, using gviz', e); return await loadGvizJson(sheetCsvUrl); }
}

/* ===== Columns & normalization ===== */
function detectColumns(rows){
  if (!rows.length) return K;
  const headerSet = new Set(Object.keys(rows[0]).map(h => h.toString()));
  const lowerToReal = {}; headerSet.forEach(h => lowerToReal[h.toLowerCase()] = h);
  const out = {...K};
  for (const target in ALIASES){
    for (const alias of ALIASES[target]){
      if (alias in lowerToReal){ out[target] = lowerToReal[alias]; break; }
    }
  }
  if (!headerSet.has(out.Layer)) out.Layer = out.Category;
  if (!headerSet.has(out.Latitude) || !headerSet.has(out.Longitude)){
    const candidates = Array.from(headerSet).filter(h => /coord|location|point|lat|lon|geometry|geo/i.test(h));
    out._combined = candidates[0] || null;
  }
  return out;
}
function parseCoordPair(text){
  if (!text) return [NaN,NaN];
  const s=String(text).trim();
  let m=s.match(/^\s*([-+]?\d+(\.\d+)?)\s*[,;]\s*([-+]?\d+(\.\d+)?)\s*$/);
  if (m) return [parseFloat(m[1]), parseFloat(m[3])];
  m=s.match(/POINT\s*\(\s*([-+]?\d+(\.\d+)?)\s+([-+]?\d+(\.\d+)?)\s*\)/i);
  if (m) return [parseFloat(m[3]), parseFloat(m[1])];
  m=s.match(/lat\s*[:=]\s*([-+]?\d+(\.\d+)?).*(lon|lng)\s*[:=]\s*([-+]?\d+(\.\d+)?)/i);
  if (m) return [parseFloat(m[1]), parseFloat(m[4])];
  return [NaN,NaN];
}
function normalizeRows(rows){
  const cols = detectColumns(rows);
  return rows.map(r => {
    let lat = Number(r[cols.Latitude]);
    let lon = Number(r[cols.Longitude]);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)){
      if (cols._combined){
        const [pLat,pLon] = parseCoordPair(r[cols._combined]);
        if (Number.isFinite(pLat) && Number.isFinite(pLon)){ lat=pLat; lon=pLon; }
      }
    }
    return {
      [K.name]: r[cols.Name],
      [K.category]: r[cols.Category],
      [K.layer]: r[cols.Layer],
      [K.lat]: lat, [K.lon]: lon,
      [K.address]: r[cols.Address],
      [K.notes]: r[cols.Notes],
      [K.url]: r[cols.URL]
    };
  });
}

/* ===== Filters & render ===== */
function refreshFilters(){
  const cats = Array.from(new Set(rawRows.map(r => (r[K.category] ?? '').toString().trim()).filter(Boolean))).sort();
  document.getElementById('category').innerHTML =
    '<option value="">All</option>' + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
}
function applyFilters(){
  const q = (elQ.value || '').trim().toLowerCase();
  const c = elCat.value;

  filtered = rawRows.filter(r => {
    const inCat = !c || (r[K.category] ?? '').toString() === c;
    const text = [r[K.name], r[K.address], r[K.notes], r[K.category], r[K.layer]]
      .map(v => (v ?? '').toString().toLowerCase()).join(' • ');
    const inQ = !q || text.includes(q);
    const lat = Number(r[K.lat]), lon = Number(r[K.lon]);
    const coordsOk = Number.isFinite(lat) && Number.isFinite(lon);
    return inCat && inQ && coordsOk;
  });

  elCounts.textContent = String(filtered.length);
  setStatus(`Loaded ${rawRows.length} rows • Showing ${filtered.length} with coordinates`, true);
  renderResults();
}
function renderResults(){
  elResults.innerHTML = '';
  if (!filtered.length){
    elResults.innerHTML = `<div class="text-xs text-gray-500">No results.</div>`;
    return;
  }
  filtered.forEach((r) => {
    const title = escapeHtml(r[K.name] ?? 'Untitled');
    const cat = escapeHtml(r[K.category] ?? '');
    const lay = escapeHtml(r[K.layer] ?? '');
    const addr = escapeHtml(r[K.address] ?? '');
    const url = (r[K.url] ?? '').toString().trim();
    const lat = Number(r[K.lat]), lon = Number(r[K.lon]);
    const gmaps = `https://www.google.com/maps?q=${encodeURIComponent(lat+','+lon)}`;

    const card = document.createElement('div');
    card.className = 'border rounded-xl p-2 hover:bg-gray-50';
    card.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div>
          <div class="font-medium">${title}</div>
          <div class="mt-1 space-x-1">
            ${cat ? `<span class="chip">${cat}</span>` : ''}
            ${lay ? `<span class="chip">${lay}</span>` : ''}
          </div>
          ${addr ? `<div class="mt-1 text-xs text-gray-600">${addr}</div>` : ''}
        </div>
        <div class="flex flex-col items-end gap-1">
          <a href="${gmaps}" target="_blank" class="text-xs text-blue-600 underline">Open in Google Maps</a>
          ${url ? `<a href="${escapeAttr(url)}" target="_blank" class="text-xs text-blue-600 underline">Open link</a>` : ''}
        </div>
      </div>`;
    elResults.appendChild(card);
  });
}

/* ===== Events ===== */
function doSearch(){ showResults(true); applyFilters(); }
document.getElementById('btnSearch').addEventListener('click', doSearch);
elQ.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });

elCat.addEventListener('change', () => { if (resultsVisible) applyFilters(); });

document.getElementById('btnReset').addEventListener('click', () => {
  elQ.value=''; elCat.value='';
  showResults(false);
  setStatus(`Loaded ${rawRows.length} rows • Waiting for search…`);
});

/* ===== Boot ===== */
(async function boot(){
  document.getElementById('mymapsBrowser').src = SRC_MYMAP; // keep context map
  setStatus('Loading data…');
  try{
    const rows = await loadSheetRows(SRC_CSV);
    rawRows = normalizeRows(rows);
    refreshFilters();
    setStatus(`Loaded ${rawRows.length} rows • Waiting for search…`);
  }catch(e){
    console.error(e);
    setStatus('Failed to load data — check CSV URL & publish settings', false);
  }
})();
</script>
</body>
</html>
