<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Maps + Data Browser (GH Pages • Minimal)</title>
  <meta name="description" content="Embed Google My Maps and browse the same data with search & filters powered by a published Google Sheet CSV (with gviz fallback).">
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="icon" href="data:,">
  <style>
    html, body { height: 100%; }
    #map { height: calc(100vh - 160px); } /* a bit taller now that setup panel is gone */
    /* Plain CSS (no Tailwind @apply) */
    .chip {
      display:inline-block; padding: 0.125rem 0.5rem; font-size: 0.75rem;
      border-radius: 9999px; border: 1px solid rgb(209 213 219);
    }
    .tab-btn-active {
      background:#fff; border:1px solid rgb(209 213 219); border-bottom:0; font-weight:600;
    }
    .btn-tab { border:1px solid transparent; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-4">
    <header class="mb-4 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">My Maps + Filterable Browser</h1>
        <p class="text-sm text-gray-600">CSV first, with automatic gviz JSON fallback. URL overrides: <code>?mymap=...&csv=...&sheet=...</code></p>
      </div>
      <div class="text-xs text-gray-500">Single-file • No backend</div>
    </header>

    <!-- Tabs -->
    <div class="border-b mb-3 flex items-center gap-2">
      <button id="tab-mymap" class="btn-tab px-3 py-2 rounded-t-lg tab-btn-active">My Map</button>
      <button id="tab-browser" class="btn-tab px-3 py-2 rounded-t-lg hover:bg-white/60">Data Browser</button>
      <button id="tab-sheet" class="btn-tab px-3 py-2 rounded-t-lg hover:bg-white/60">Sheet</button>
    </div>

    <!-- My Map -->
    <section id="panel-mymap" class="bg-white rounded-2xl shadow overflow-hidden">
      <div class="aspect-[16/9]">
        <iframe id="mymapsFrame" class="w-full h-full" src="https://www.google.com/maps/d/embed?mid=1flufWwvpBFS6g7t7rddkzZnWsyeMVCw&ehbc=2E312F" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <div class="p-3 text-xs text-gray-600 border-t">
        The embedded My Map is read-only here. Use the Data Browser tab to search & filter the CSV/JSON data.
      </div>
    </section>

    <!-- Data Browser -->
    <section id="panel-browser" class="hidden bg-white rounded-2xl shadow overflow-hidden mt-3">
      <div class="grid lg:grid-cols-3 gap-0">
        <aside class="lg:col-span-1 border-r p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Filters</h2>
            <button id="btnReset" class="text-xs px-2 py-1 rounded-lg border hover:bg-gray-50">Reset</button>
          </div>

          <label class="block mb-3">
            <span class="text-sm font-medium">Search (name, address, notes)</span>
            <input id="q" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="Type to search..."/>
          </label>

          <div class="grid grid-cols-2 gap-2">
            <label class="block">
              <span class="text-sm font-medium">Category</span>
              <select id="category" class="mt-1 w-full border rounded-xl px-3 py-2">
                <option value="">All</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm font-medium">Layer</span>
              <select id="layer" class="mt-1 w-full border rounded-xl px-3 py-2">
                <option value="">All</option>
              </select>
            </label>
          </div>

          <div class="mt-3">
            <span class="text-sm font-medium">Results</span>
            <div id="results" class="mt-2 max-h-72 overflow-auto space-y-2 pr-1"></div>
          </div>
        </aside>

        <main class="lg:col-span-2">
          <div id="map"></div>
        </main>
      </div>
    </section>

    <!-- Sheet Embed -->
    <section id="panel-sheet" class="hidden bg-white rounded-2xl shadow overflow-hidden mt-3">
      <div class="aspect-[16/9]">
        <iframe id="sheetFrame" class="w-full h-full" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRPslbQfk_lxbc0FXX6IrdJEh1cfnuSpJRITDM9X4vxxXbVcimphgQJ1G4dVSJFCuloUAcrLkod-U9-/pubhtml?gid=2019963302&single=true&widget=true&headers=false" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <div class="p-3 text-xs text-gray-600 border-t">
        Published Google Sheet (read-only). Update the original Sheet to change both this view and the data powering the Data Browser.
      </div>
    </section>

    <footer class="py-6 text-center text-xs text-gray-500">
      Built with Google My Maps (embed) + Google Sheets (CSV or gviz JSON) + Leaflet.
    </footer>
  </div>

<script>
/* =====================
   Minimal GH Pages app (no setup panel)
   - Defaults below; URL params can override (?mymap=...&csv=...&sheet=...)
   - CSV fetch with gviz JSON fallback
   ===================== */

const DEFAULTS = {
  mymap: "https://www.google.com/maps/d/embed?mid=1flufWwvpBFS6g7t7rddkzZnWsyeMVCw&ehbc=2E312F",
  csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPslbQfk_lxbc0FXX6IrdJEh1cfnuSpJRITDM9X4vxxXbVcimphgQJ1G4dVSJFCuloUAcrLkod-U9-/pub?gid=2019963302&single=true&output=csv",
  sheet: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPslbQfk_lxbc0FXX6IrdJEh1cfnuSpJRITDM9X4vxxXbVcimphgQJ1G4dVSJFCuloUAcrLkod-U9-/pubhtml?gid=2019963302&single=true&widget=true&headers=false"
};

function getParam(name, fallback){ return new URLSearchParams(location.search).get(name) || fallback; }

let rawRows = [];
let filtered = [];
let markerLayer = null;
let map = null;

const COL_KEYS = { name:'Name', category:'Category', layer:'Layer', lat:'Latitude', lon:'Longitude', address:'Address', notes:'Notes', url:'URL' };
const ALIASES = {
  Name: ['name','title','naziv','ime','object','poi','place'],
  Category: ['category','type','group','kategorija','vrsta'],
  Layer: ['layer','sloj','list','sheet','tab'],
  Latitude: ['latitude','lat','y','y_coord','ycoord','φ','northing'],
  Longitude: ['longitude','lon','lng','long','x','x_coord','xcoord','λ','easting'],
  Address: ['address','location','addr','adresa','mjesto','city','town'],
  Notes: ['notes','description','desc','napomena','opis','info'],
  URL: ['url','link','website','href','web','maps','gmaps']
};

const elFrame     = document.getElementById('mymapsFrame');
const elSheetFrame= document.getElementById('sheetFrame');

const elTabMy   = document.getElementById('tab-mymap');
const elTabBr   = document.getElementById('tab-browser');
const elTabSh   = document.getElementById('tab-sheet');
const elPanelMy = document.getElementById('panel-mymap');
const elPanelBr = document.getElementById('panel-browser');
const elPanelSh = document.getElementById('panel-sheet');

const elQ       = document.getElementById('q');
const elCat     = document.getElementById('category');
const elLayer   = document.getElementById('layer');
const elResults = document.getElementById('results');
const elReset   = document.getElementById('btnReset');

function escapeHtml(s) {
  return (s ?? '').toString().replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));
}
function escapeAttr(s) { return escapeHtml(s).replace(/"/g, '&quot;'); }

function activateTab(which) {
  const mapTab = which === 'my'; const browserTab = which === 'br'; const sheetTab = which === 'sh';
  elPanelMy.classList.toggle('hidden', !mapTab);
  elPanelBr.classList.toggle('hidden', !browserTab);
  elPanelSh.classList.toggle('hidden', !sheetTab);
  elTabMy.classList.toggle('tab-btn-active', mapTab);
  elTabBr.classList.toggle('tab-btn-active', browserTab);
  elTabSh.classList.toggle('tab-btn-active', sheetTab);
  if (browserTab && map) setTimeout(() => map.invalidateSize(), 150);
}

function detectColumns(rows){
  if (!rows.length) return COL_KEYS;
  const headerSet = new Set(Object.keys(rows[0]).map(h => h.toString()));
  const lowerToReal = {}; headerSet.forEach(h => lowerToReal[h.toLowerCase()] = h);
  const out = {...COL_KEYS};
  for (const target in ALIASES){
    for (const alias of ALIASES[target]){
      if (alias in lowerToReal){ out[target] = lowerToReal[alias]; break; }
    }
  }
  if (!headerSet.has(out.Layer)) out.Layer = out.Category;
  return out;
}
function normalizeRows(rows){
  const cols = detectColumns(rows);
  return rows.map(r => ({
    [COL_KEYS.name]: r[cols.Name],
    [COL_KEYS.category]: r[cols.Category],
    [COL_KEYS.layer]: r[cols.Layer],
    [COL_KEYS.lat]: Number(r[cols.Latitude]),
    [COL_KEYS.lon]: Number(r[cols.Longitude]),
    [COL_KEYS.address]: r[cols.Address],
    [COL_KEYS.notes]: r[cols.Notes],
    [COL_KEYS.url]: r[cols.URL]
  }));
}

function ensureMap() {
  if (map) return map;
  map = L.map('map').setView([45.815, 15.9819], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);
  return map;
}

async function tryPapaCsv(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      header: true, download: true, dynamicTyping: true,
      complete: (res) => {
        const rows = res.data.filter(row => Object.keys(row).some(k => String(row[k] || '').trim() !== ''));
        resolve(rows);
      },
      error: (err) => reject(err)
    });
  });
}
function buildGvizUrl(sheetCsvUrl) {
  const mKey = sheetCsvUrl.match(/\/spreadsheets\/d\/e\/([^\/]+)/);
  const mGid = sheetCsvUrl.match(/[?&]gid=([0-9]+)/);
  if (!mKey || !mGid) return null;
  return `https://docs.google.com/spreadsheets/d/e/${mKey[1]}/gviz/tq?gid=${mGid[1]}&tqx=out:json`;
}
function loadGvizJson(sheetCsvUrl) {
  return new Promise((resolve, reject) => {
    const url = buildGvizUrl(sheetCsvUrl);
    if (!url) return reject(new Error('Could not build gviz URL from Sheet CSV URL.'));
    window.google = window.google || {}; window.google.visualization = window.google.visualization || {};
    window.google.visualization.Query = {
      setResponse: function(resp) {
        try {
          const table = resp.table;
          const cols = table.cols.map(c => c.label || c.id);
          const rows = table.rows.map(r => {
            const o = {}; r.c.forEach((cell, idx) => { const label = cols[idx] || `col${idx}`; o[label] = cell ? cell.v : null; });
            return o;
          });
          resolve(rows);
        } catch (e) { reject(e); }
        finally { delete window.google.visualization.Query; const s = document.getElementById('gvizScriptLoader'); if (s) s.remove(); }
      }
    };
    const s = document.createElement('script'); s.src = url; s.async = true; s.id = 'gvizScriptLoader';
    s.onerror = () => { delete window.google.visualization.Query; reject(new Error('Failed to load gviz JSON.')); };
    document.body.appendChild(s);
  });
}
async function loadSheetRows(sheetCsvUrl) {
  try { return await tryPapaCsv(sheetCsvUrl); }
  catch (e) { console.warn('CSV load failed (using gviz fallback):', e); return await loadGvizJson(sheetCsvUrl); }
}

function refreshFiltersAndMap() {
  const cats = Array.from(new Set(rawRows.map(r => (r[COL_KEYS.category] ?? '').toString().trim()).filter(Boolean))).sort();
  const lays = Array.from(new Set(rawRows.map(r => (r[COL_KEYS.layer] ?? '').toString().trim()).filter(Boolean))).sort();
  elCat.innerHTML = '<option value="">All</option>' + cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  elLayer.innerHTML = '<option value="">All</option>' + lays.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join('');
  applyFilters();
}
function applyFilters() {
  const q = elQ.value.trim().toLowerCase();
  const c = elCat.value;
  const l = elLayer.value;
  filtered = rawRows.filter(r => {
    const inCat = !c || (r[COL_KEYS.category] ?? '').toString() === c;
    const inLay = !l || (r[COL_KEYS.layer] ?? '').toString() === l;
    const text = [r[COL_KEYS.name], r[COL_KEYS.address], r[COL_KEYS.notes], r[COL_KEYS.category], r[COL_KEYS.layer]]
                .map(v => (v ?? '').toString().toLowerCase()).join(' • ');
    const inQ = !q || text.includes(q);
    const lat = Number(r[COL_KEYS.lat]), lon = Number(r[COL_KEYS.lon]);
    const coordsOk = Number.isFinite(lat) && Number.isFinite(lon);
    return inCat && inLay && inQ && coordsOk;
  });
  renderResults();
  ensureMap();
  markerLayer.clearLayers();
  const bounds = [];
  filtered.forEach((r) => {
    const lat = Number(r[COL_KEYS.lat]), lon = Number(r[COL_KEYS.lon]);
    const marker = L.marker([lat, lon]).addTo(markerLayer);
    const title = escapeHtml(r[COL_KEYS.name] ?? 'Untitled');
    const cat = escapeHtml(r[COL_KEYS.category] ?? '');
    const lay = escapeHtml(r[COL_KEYS.layer] ?? '');
    const addr = escapeHtml(r[COL_KEYS.address] ?? '');
    const notes = escapeHtml(r[COL_KEYS.notes] ?? '');
    const url = (r[COL_KEYS.url] ?? '').toString().trim();
    const html = `
      <div class="text-sm">
        <div class="font-semibold">${title}</div>
        <div class="mt-1 space-x-1">
          ${cat ? `<span class="chip">${cat}</span>` : ''}
          ${lay ? `<span class="chip">${lay}</span>` : ''}
        </div>
        ${addr ? `<div class="mt-1 text-xs text-gray-600">${addr}</div>` : ''}
        ${notes ? `<div class="mt-1 text-xs">${notes}</div>` : ''}
        ${url ? `<div class="mt-2"><a href="${escapeAttr(url)}" target="_blank" class="text-blue-600 underline">Open link</a></div>` : ''}
      </div>`;
    marker.bindPopup(html);
    bounds.push([lat, lon]);
  });
  if (bounds.length) map.fitBounds(bounds, { padding: [20,20] });
}
function renderResults() {
  elResults.innerHTML = '';
  if (!filtered.length) { elResults.innerHTML = `<div class="text-xs text-gray-500">No results.</div>`; return; }
  filtered.forEach((r) => {
    const title = escapeHtml(r[COL_KEYS.name] ?? 'Untitled');
    const cat = escapeHtml(r[COL_KEYS.category] ?? '');
    const lay = escapeHtml(r[COL_KEYS.layer] ?? '');
    const addr = escapeHtml(r[COL_KEYS.address] ?? '');
    const url = (r[COL_KEYS.url] ?? '').toString().trim();
    const card = document.createElement('div');
    card.className = 'border rounded-xl p-2 hover:bg-gray-50 cursor-pointer';
    card.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div>
          <div class="font-medium">${title}</div>
          <div class="mt-1 space-x-1">
            ${cat ? `<span class="chip">${cat}</span>` : ''}
            ${lay ? `<span class="chip">${lay}</span>` : ''}
          </div>
          ${addr ? `<div class="mt-1 text-xs text-gray-600">${addr}</div>` : ''}
        </div>
        ${url ? `<a href="${escapeAttr(url)}" target="_blank" class="text-xs text-blue-600 underline">Open</a>` : ''}
      </div>`;
    card.addEventListener('click', () => { const lat = Number(r[COL_KEYS.lat]), lon = Number(r[COL_KEYS.lon]); ensureMap(); map.setView([lat, lon], 15); activateTab('br'); });
    elResults.appendChild(card);
  });
}

// Events
elTabMy.addEventListener('click', () => activateTab('my'));
elTabBr.addEventListener('click', () => activateTab('br'));
elTabSh.addEventListener('click', () => activateTab('sh'));
elReset.addEventListener('click', () => { elQ.value=''; elCat.value=''; elLayer.value=''; applyFilters(); });

// Boot
(async function boot(){
  const mymap = getParam('mymap', DEFAULTS.mymap);
  const csv   = getParam('csv', DEFAULTS.csv);
  const sheet = getParam('sheet', DEFAULTS.sheet);

  elFrame.src = mymap;
  elSheetFrame.src = sheet;

  try {
    const rows = await loadSheetRows(csv);
    rawRows = normalizeRows(rows);
    refreshFiltersAndMap();
  } catch (e) {
    console.warn('Failed to load data:', e);
  }

  activateTab('my');
})();
</script>
</body>
</html>

